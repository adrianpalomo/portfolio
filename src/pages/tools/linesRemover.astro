---
import BasicLayout from '@/layouts/BasicLayout.astro';
import Copy from '@/components/icons/Copy2.astro';
import Trash from '@/components/icons/Trash.astro';
---

<BasicLayout title="Lines remover | Adrian Palomo">
	<div class="min-h-screen bg-gray-900 p-4 font-sans text-gray-100">
		<!-- Header -->
		<h1 class="mb-6 text-3xl font-bold text-blue-500">Eliminar líneas</h1>

		<!-- Control Panel -->
		<div
			class="mb-4 rounded-lg border border-gray-700 bg-gray-800 p-4 shadow-lg"
		>
			<!-- Input Section -->
			<div class="mb-4">
				<label
					for="textoEntrada"
					class="mb-2 block text-sm font-medium text-gray-300"
					>Pega aquí tu texto:</label
				>
				<textarea
					id="textoEntrada"
					class="w-full rounded-md border border-gray-600 bg-gray-700 p-3 font-mono text-sm text-gray-100 placeholder-gray-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:outline-none"
					rows="8"
					placeholder="Escribe o pega tu texto aquí..."></textarea>
			</div>

			<!-- Search & Options Section -->
			<div class="mb-4 flex flex-col gap-3">
				<div class="flex flex-wrap items-center gap-3">
					<input
						type="text"
						id="keywordInput"
						placeholder="Palabra clave a buscar..."
						class="min-w-48 flex-1 rounded-md border border-gray-600 bg-gray-700 px-4 py-2 text-gray-100 placeholder-gray-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:outline-none"
					/>
					<button
						id="formatButton"
						class="rounded-md bg-blue-600 px-6 py-2 font-medium text-white transition-colors hover:bg-blue-700"
						>Procesar</button
					>
				</div>
			</div>

			<!-- Toggle Options -->
			<div class="flex flex-wrap items-center gap-3">
				<label class="flex cursor-pointer items-center gap-2">
					<input
						type="checkbox"
						id="maintainOrRemove"
						class="h-4 w-4 rounded border-gray-600 bg-gray-700 text-blue-600 focus:ring-2 focus:ring-blue-500"
					/>
					<span
						class="text-sm text-gray-300"
						title="Marcado: Mantener líneas con coincidencias | Desmarcado: Eliminar líneas con coincidencias"
						>Mantener coincidencias</span
					>
				</label>
				<label class="flex cursor-pointer items-center gap-2">
					<input
						type="checkbox"
						id="caseSensitive"
						class="h-4 w-4 rounded border-gray-600 bg-gray-700 text-blue-600 focus:ring-2 focus:ring-blue-500"
					/>
					<span class="text-sm text-gray-300"
						>Sensible a mayúsculas</span
					>
				</label>
				<label class="flex cursor-pointer items-center gap-2">
					<input
						type="checkbox"
						id="wholeWord"
						class="h-4 w-4 rounded border-gray-600 bg-gray-700 text-blue-600 focus:ring-2 focus:ring-blue-500"
					/>
					<span class="text-sm text-gray-300">Palabra completa</span>
				</label>
			</div>

			<!-- Status Messages -->
			<div class="mt-3 flex items-center gap-4">
				<span id="valid" class="text-sm font-medium text-green-500"
				></span>
				<span id="invalid" class="text-sm font-medium text-red-500"
				></span>
			</div>
		</div>

		<!-- Result Toolbar -->
		<div
			class="flex flex-wrap items-center justify-between gap-4 border-b border-gray-700 bg-gray-800 px-5 py-4"
		>
			<div class="flex items-center gap-3">
				<p class="font-bold text-gray-300">Resultado</p>
				<button
					id="copyButton"
					class="rounded-md bg-gray-600 p-2 text-gray-100 transition-colors hover:bg-gray-500"
					title="Copiar"
				>
					<Copy />
				</button>
				<button
					id="clearButton"
					class="rounded-md bg-gray-600 p-2 text-gray-100 transition-colors hover:bg-gray-500"
					title="Limpiar"
				>
					<Trash />
				</button>
			</div>

			<div class="flex items-center gap-3">
				<div class="relative flex items-center">
					<input
						type="text"
						id="buscador"
						placeholder="Buscar en resultado..."
						class="min-w-48 rounded-md border border-gray-600 bg-gray-700 px-4 py-2 pr-16 text-sm text-gray-100 placeholder-gray-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:outline-none"
					/>
					<span
						id="contadorCoincidencias"
						class="absolute right-3 text-xs text-gray-400"></span>
				</div>
				<select
					id="historyPicklist"
					onchange="loadFromHistory(this.value)"
					class="max-w-72 min-w-48 rounded-md border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-100"
				>
					<option disabled selected>Historial de procesados</option>
				</select>
				<button
					id="clearHistoryButton"
					class="rounded-md bg-red-600 px-3 py-2 text-sm font-medium text-white transition-colors hover:bg-red-700"
					title="Borrar historial">Limpiar</button
				>
			</div>
		</div>

		<!-- Result Output -->
		<div class="mt-4 rounded-lg border border-gray-700 bg-gray-800">
			<pre
				class="overflow-x-auto rounded-lg bg-gray-800 p-4">
				<code id="textoSalida" class="block font-mono text-sm text-gray-100" style="white-space: pre-wrap; word-wrap: break-word;" />
			</pre>
		</div>
	</div>

	<link
		rel="stylesheet"
		href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.css"
	/>
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"
	></script>
</BasicLayout>

<script type="module" is:inline>
	document.addEventListener('DOMContentLoaded', function () {
		var textoGuardado = localStorage.getItem('textoGuardado');
		if (textoGuardado) {
			document.getElementById('textoEntrada').value = textoGuardado;
		}
		updateHistoryPicklist();

		if (document.getElementById('textoSalida').dataset.highlighted) {
			delete document.getElementById('textoSalida').dataset.highlighted;
		}

		document
			.getElementById('buscador')
			.addEventListener('input', function () {
				buscarEnTexto();
			});

		document
			.getElementById('formatButton')
			.addEventListener('click', function () {
				eliminarLineas();
			});

		document
			.getElementById('clearHistoryButton')
			.addEventListener('click', clearHistory);

		// Event listeners para los botones Copy y Clear del resultado
		document
			.getElementById('copyButton')
			.addEventListener('click', copiarAlPortapapeles);
		document
			.getElementById('clearButton')
			.addEventListener('click', limpiarTexto);

		// Permitir presionar Enter en el campo de keyword para procesar
		document
			.getElementById('keywordInput')
			.addEventListener('keypress', function (event) {
				if (event.key === 'Enter') {
					eliminarLineas();
				}
			});

		// Permitir presionar Enter en el textarea para procesar
		document
			.getElementById('textoEntrada')
			.addEventListener('keypress', function (event) {
				if (event.key === 'Enter' && event.ctrlKey) {
					eliminarLineas();
				}
			});
	});

	function eliminarLineas() {
		var input = document.getElementById('textoEntrada').value;
		var mantenerOEliminar =
			document.getElementById('maintainOrRemove').checked;
		var textoABuscar = document.getElementById('keywordInput').value;
		var caseSensitive = document.getElementById('caseSensitive').checked;
		var wholeWord = document.getElementById('wholeWord').checked;
		var lineas = input.split('\n');
		var textoProcesado = '';

		// Si no hay texto a buscar, mostrar todo el texto sin procesar
		if (!textoABuscar) {
			document.getElementById('valid').textContent = '';
			document.getElementById('invalid').textContent =
				'Ingresa una palabra clave';
			return;
		}

		var flags = caseSensitive ? 'g' : 'gi';
		var pattern = wholeWord
			? '\\b' + escapeRegExp(textoABuscar) + '\\b'
			: escapeRegExp(textoABuscar);
		var regex = new RegExp(pattern, flags);

		var lineasProcesadas = 0;
		lineas.forEach(function (linea) {
			var coincide = regex.test(linea);
			// Si mantenerOEliminar está checked (true) = MANTENER las que coinciden
			// Si mantenerOEliminar está unchecked (false) = ELIMINAR las que coinciden (mantener las que NO coinciden)
			if (
				(mantenerOEliminar && coincide) ||
				(!mantenerOEliminar && !coincide)
			) {
				textoProcesado += linea + '\n';
				lineasProcesadas++;
			}
		});

		document.getElementById('textoSalida').textContent =
			textoProcesado.trim();
		hljs.highlightElement(document.getElementById('textoSalida'));
		localStorage.setItem('textoGuardado', input);

		// Actualizar indicadores
		var totalLineas = lineas.length;
		var accion = mantenerOEliminar ? 'mantenidas' : 'eliminadas';
		document.getElementById('valid').textContent =
			`${lineasProcesadas} líneas procesadas de ${totalLineas}`;
		document.getElementById('invalid').textContent = '';

		// Agregar al historial si no está duplicado
		if (
			textoProcesado.trim() &&
			!checkDuplicateInHistory(textoProcesado.trim())
		) {
			addToHistory(textoProcesado.trim());
		}
	}

	function buscarEnTexto() {
		var textoABuscar = document.getElementById('buscador').value;
		var caseSensitive = document.getElementById('caseSensitive').checked;
		var wholeWord = document.getElementById('wholeWord').checked;

		if (textoABuscar.length < 2) {
			document.getElementById('contadorCoincidencias').innerText = '';
			// Restaurar texto original sin highlighting
			var originalText = document.querySelector('code').textContent;
			document.querySelector('code').textContent = originalText;
			hljs.highlightElement(document.querySelector('code'));
			return;
		}

		var flags = caseSensitive ? 'g' : 'gi';
		var pattern = wholeWord
			? '\\b' + escapeRegExp(textoABuscar) + '\\b'
			: escapeRegExp(textoABuscar);

		var originalText = document.querySelector('code').textContent;
		var regex = new RegExp(pattern, flags);

		var matches = originalText.match(regex);
		var contador = matches ? matches.length : 0;
		document.getElementById('contadorCoincidencias').innerText = contador;

		var highlightedText = originalText.replace(regex, function (match) {
			return '<mark>' + match + '</mark>';
		});
		document.querySelector('code').innerHTML = highlightedText;
		hljs.highlightElement(document.querySelector('code'));
	}

	function escapeRegExp(string) {
		return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
	}

	function copiarAlPortapapeles() {
		const texto = document.querySelector('code').textContent;

		if (navigator.clipboard) {
			navigator.clipboard.writeText(texto).then(() => {
				mostrarFeedbackCopia();
			});
		} else {
			// Fallback para navegadores antiguos
			const elemento = document.createElement('textarea');
			elemento.value = texto;
			document.body.appendChild(elemento);
			elemento.select();
			document.execCommand('copy');
			document.body.removeChild(elemento);
			mostrarFeedbackCopia();
		}
	}

	function mostrarFeedbackCopia() {
		var validSpan = document.getElementById('valid');
		validSpan.textContent = '¡Copiado al portapapeles!';
		setTimeout(function () {
			validSpan.textContent = '';
		}, 2000);
	}

	function limpiarTexto() {
		document.getElementById('textoEntrada').value = '';
		document.getElementById('textoSalida').textContent = '';
		document.getElementById('buscador').value = '';
		document.getElementById('keywordInput').value = '';
		document.getElementById('contadorCoincidencias').innerText = '';
		document.getElementById('valid').textContent = '';
		document.getElementById('invalid').textContent = '';
		localStorage.removeItem('textoGuardado');
	}

	function addToHistory(jsonText) {
		var history = JSON.parse(localStorage.getItem('jsonHistory') || '[]');

		var entry = {
			timestamp: new Date().toISOString(),
			text: jsonText,
		};

		history.unshift(entry);
		history = history.slice(0, 50);
		localStorage.setItem('jsonHistory', JSON.stringify(history));

		updateHistoryPicklist();
	}

	function checkDuplicateInHistory(jsonText) {
		var history = JSON.parse(localStorage.getItem('jsonHistory') || '[]');
		for (var i = 0; i < history.length; i++) {
			if (history[i].text === jsonText) {
				return true;
			}
		}
		return false;
	}

	function clearHistory() {
		localStorage.setItem('jsonHistory', JSON.stringify([]));
		updateHistoryPicklist();
	}

	function updateHistoryPicklist() {
		var history = JSON.parse(localStorage.getItem('jsonHistory') || '[]');
		var picklist = document.getElementById('historyPicklist');

		picklist.innerHTML =
			'<option disabled selected>Historial de procesados</option>';

		history.forEach(function (entry) {
			var date = new Date(entry.timestamp);
			var dateString = `[${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())} ${pad(date.getDate())}/${pad(date.getMonth() + 1)}/${date.getFullYear()}]`;
			var textPreview = entry.text ? entry.text.substring(0, 120) : '';
			var option = new Option(
				dateString + ' ' + textPreview,
				JSON.stringify(entry)
			);
			picklist.add(option);
		});
	}

	function pad(number) {
		return number < 10 ? '0' + number : number;
	}

	function loadFromHistory(selectedValue) {
		if (!selectedValue) return;

		var entry = JSON.parse(selectedValue);
		if (entry && entry.text) {
			document.getElementById('textoSalida').textContent = entry.text;
			hljs.highlightElement(document.getElementById('textoSalida'));
		}
	}

	// Hacer la función global para que el onchange del select pueda accederla
	window.loadFromHistory = loadFromHistory;
</script>

<style>
	/* General Styles */
	button {
		cursor: pointer;
	}

	button:active {
		transform: scale(0.95);
		transition: transform 0.2s ease-in-out;
	}

	/* SVG Icon Sizing */
	svg {
		width: 20px;
		height: 20px;
	}

	/* Code Highlighting Styles */
	mark {
		background-color: #fbbf24 !important;
		color: #000 !important;
		padding: 2px 4px;
		border-radius: 2px;
	}

	code {
		display: block;
		width: 100%;
		min-height: 100px;
	}

	/* Dark theme for highlight.js */
	pre {
		margin: 0;
		background-color: #1f2937 !important;
	}

	pre code.hljs {
		background-color: #1f2937 !important;
		color: #f3f4f6 !important;
	}

	/* Animation */
	@keyframes fadeInUp {
		from {
			opacity: 0;
			transform: translateY(20px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	.bg-gray-800 {
		animation: fadeInUp 0.3s ease-out;
	}

	/* Custom Scrollbar for pre/code */
	pre::-webkit-scrollbar {
		height: 8px;
		width: 8px;
	}

	pre::-webkit-scrollbar-track {
		background: #374151;
		border-radius: 4px;
	}

	pre::-webkit-scrollbar-thumb {
		background: #4b5563;
		border-radius: 4px;
	}

	pre::-webkit-scrollbar-thumb:hover {
		background: #6b7280;
	}
</style>
