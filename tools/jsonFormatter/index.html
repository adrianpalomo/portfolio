<!DOCTYPE html><html> <head><title>JSON Formatter | Adrian Palomo</title><meta name="viewport" content="width=device-width, initial-scale=1"><meta charset="UTF-8"><meta property="og:type" content="website"><meta property="og:url" content="https://adrianpalomo.com/"><meta property="og:title" content="Adrián Palomo | Tools"><meta property="og:site_name" content="Adrián Palomo | Tools"><meta property="og:locale" content="es_ES"><meta name="robots" content="noindex, nofollow, noimageindex"><link rel="icon" type="image/png" href="/images/Fav.webp"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/a11y-light.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script><link rel="stylesheet" href="/_astro/investmentCalculator.VUgsTnFL.css">
<style>button[data-astro-cid-mwlrrin4]{cursor:pointer}button[data-astro-cid-mwlrrin4]:active{transform:scale(.95);transition:transform .2s ease-in-out}#jsonEditor[data-astro-cid-mwlrrin4] .CodeMirror[data-astro-cid-mwlrrin4]{width:100%!important;height:auto!important;background-color:#1f2937!important;color:#f3f4f6!important;font-family:Monaco,Menlo,Ubuntu Mono,Consolas,source-code-pro,monospace!important;font-size:14px!important;line-height:1.6!important;border:none;border-radius:8px}#jsonEditor[data-astro-cid-mwlrrin4] .CodeMirror-lines[data-astro-cid-mwlrrin4]{padding:12px 0!important}#jsonEditor[data-astro-cid-mwlrrin4] .CodeMirror[data-astro-cid-mwlrrin4],#jsonEditor[data-astro-cid-mwlrrin4] .CodeMirror-code[data-astro-cid-mwlrrin4],#jsonEditor[data-astro-cid-mwlrrin4] .CodeMirror-lines[data-astro-cid-mwlrrin4],#jsonEditor[data-astro-cid-mwlrrin4] .CodeMirror-wrap[data-astro-cid-mwlrrin4],#jsonEditor[data-astro-cid-mwlrrin4] .CodeMirror-scroll[data-astro-cid-mwlrrin4]{background-color:#1f2937!important}#jsonEditor[data-astro-cid-mwlrrin4] .CodeMirror-gutters[data-astro-cid-mwlrrin4]{background-color:#374151!important;border-right:1px solid #4b5563!important}#jsonEditor[data-astro-cid-mwlrrin4] .CodeMirror-linenumber[data-astro-cid-mwlrrin4]{color:#9ca3af!important}#jsonEditor[data-astro-cid-mwlrrin4] .CodeMirror-cursor[data-astro-cid-mwlrrin4]{border-left:1px solid #f3f4f6!important}#jsonEditor[data-astro-cid-mwlrrin4] .CodeMirror-selected[data-astro-cid-mwlrrin4]{background-color:#2563eb!important;opacity:.3}#jsonEditor[data-astro-cid-mwlrrin4] .CodeMirror-focused[data-astro-cid-mwlrrin4] .CodeMirror-selected[data-astro-cid-mwlrrin4]{background-color:#2563eb!important;opacity:.4}.json-key[data-astro-cid-mwlrrin4]{color:#9cdcfe}.json-string[data-astro-cid-mwlrrin4]{color:#ce9178}.json-number[data-astro-cid-mwlrrin4]{color:#b5cea8}.json-literal[data-astro-cid-mwlrrin4]{color:#569cd6}.search-highlight[data-astro-cid-mwlrrin4]{background-color:#fbbf24!important;color:#000!important;padding:0 2px;border-radius:2px}#jsonEditor[data-astro-cid-mwlrrin4] .CodeMirror-foldmarker[data-astro-cid-mwlrrin4]{background-color:#2563eb!important;color:#fff!important;border:1px solid #2563eb!important;border-radius:3px;padding:0 3px;font-size:11px;margin:0 2px;cursor:pointer}#jsonEditor[data-astro-cid-mwlrrin4] .CodeMirror-foldgutter[data-astro-cid-mwlrrin4]{width:16px!important}#jsonEditor[data-astro-cid-mwlrrin4] .CodeMirror-foldgutter-open[data-astro-cid-mwlrrin4],#jsonEditor[data-astro-cid-mwlrrin4] .CodeMirror-foldgutter-folded[data-astro-cid-mwlrrin4]{cursor:pointer;color:#9ca3af!important;font-size:14px!important;text-align:center;line-height:1!important}#jsonEditor[data-astro-cid-mwlrrin4] .CodeMirror-foldgutter-open[data-astro-cid-mwlrrin4]:hover,#jsonEditor[data-astro-cid-mwlrrin4] .CodeMirror-foldgutter-folded[data-astro-cid-mwlrrin4]:hover{color:#f3f4f6!important;background-color:#4b5563!important}#jsonEditor[data-astro-cid-mwlrrin4] .CodeMirror-foldgutter-open[data-astro-cid-mwlrrin4]:after{content:"▼"}#jsonEditor[data-astro-cid-mwlrrin4] .CodeMirror-foldgutter-folded[data-astro-cid-mwlrrin4]:after{content:"▶"}#jsonEditor[data-astro-cid-mwlrrin4] .CodeMirror-scroll[data-astro-cid-mwlrrin4]{overflow:visible!important;background-color:#1f2937!important}#jsonEditor[data-astro-cid-mwlrrin4] .CodeMirror-vscrollbar[data-astro-cid-mwlrrin4],#jsonEditor[data-astro-cid-mwlrrin4] .CodeMirror-hscrollbar[data-astro-cid-mwlrrin4],#jsonEditor[data-astro-cid-mwlrrin4] .CodeMirror-scrollbar-filler[data-astro-cid-mwlrrin4]{display:none!important}svg[data-astro-cid-mwlrrin4]{width:20px;height:20px}@keyframes fadeInUp{0%{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}.bg-gray-800[data-astro-cid-mwlrrin4],#jsonEditor[data-astro-cid-mwlrrin4]{animation:fadeInUp .3s ease-out}
</style></head> <body>   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css"> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldgutter.min.css"> <script type="module" src="/_astro/jsonFormatter.astro_astro_type_script_index_0_lang.BjWfsOxb.js"></script> <script type="module" src="/_astro/jsonFormatter.astro_astro_type_script_index_1_lang.Dw3JbdGL.js"></script> <script type="module" src="/_astro/jsonFormatter.astro_astro_type_script_index_2_lang.eBW3EFTE.js"></script> <script type="module" src="/_astro/jsonFormatter.astro_astro_type_script_index_3_lang.BLC_Lrdy.js"></script> <script type="module" src="/_astro/jsonFormatter.astro_astro_type_script_index_4_lang.DafNj-di.js"></script> <script type="module" src="/_astro/jsonFormatter.astro_astro_type_script_index_5_lang.BHHWpFFV.js"></script> <script type="module" src="/_astro/jsonFormatter.astro_astro_type_script_index_6_lang.BLmj5TDH.js"></script> <div class="min-h-screen bg-gray-900 p-4 font-sans text-gray-100" data-astro-cid-mwlrrin4> <h1 class="mb-6 text-3xl font-bold text-blue-500" data-astro-cid-mwlrrin4>
JSON Formatter
</h1> <!-- Control Panel --> <div class="mb-4 rounded-lg border border-gray-700 bg-gray-800 p-4 shadow-lg" data-astro-cid-mwlrrin4> <!-- Search & Replace Section --> <div class="mb-6 flex flex-col gap-3" data-astro-cid-mwlrrin4> <div class="flex flex-wrap items-center gap-3" data-astro-cid-mwlrrin4> <input type="text" id="searchInput" placeholder="Search..." class="min-w-48 flex-1 rounded-md border border-gray-600 bg-gray-700 px-4 py-2 text-gray-100 placeholder-gray-400 focus:border-transparent focus:ring-2 focus:ring-blue-500 focus:outline-none" data-astro-cid-mwlrrin4> <input type="text" id="replaceInput" placeholder="Replace with..." class="min-w-48 flex-1 rounded-md border border-gray-600 bg-gray-700 px-4 py-2 text-gray-100 placeholder-gray-400 focus:border-transparent focus:ring-2 focus:ring-blue-500 focus:outline-none" data-astro-cid-mwlrrin4> <button id="replaceAllButton" class="rounded-md bg-blue-600 px-6 py-2 font-medium text-white transition-colors hover:bg-blue-700" data-astro-cid-mwlrrin4>Replace All</button> </div> <div class="hidden" id="searchCounterContainer" data-astro-cid-mwlrrin4> <span id="searchCounter" class="rounded border border-gray-600 bg-gray-700 px-2 py-1 text-xs text-gray-400" data-astro-cid-mwlrrin4></span> </div> </div> <!-- Actions & Options --> <div class="flex flex-col justify-between gap-4 lg:flex-row" data-astro-cid-mwlrrin4> <div class="flex flex-wrap gap-3" data-astro-cid-mwlrrin4> <button id="formatButton" class="rounded-md bg-blue-600 px-6 py-2 font-medium text-white transition-colors hover:bg-blue-700" data-astro-cid-mwlrrin4>Format</button> <button id="compressButton" class="rounded-md bg-blue-600 px-6 py-2 font-medium text-white transition-colors hover:bg-blue-700" data-astro-cid-mwlrrin4>Compress</button> </div> <div class="flex flex-wrap gap-2" data-astro-cid-mwlrrin4> <button id="cleanEscapesBtn" class="rounded-md border border-gray-600 bg-gray-700 px-4 py-2 text-xs font-medium text-gray-300 transition-all hover:bg-gray-600" data-active="false" data-astro-cid-mwlrrin4>Clean Escapes</button> <button id="autoFormatBtn" class="rounded-md border border-blue-600 bg-blue-600 px-4 py-2 text-xs font-medium text-white transition-all" data-active="true" data-astro-cid-mwlrrin4>Auto Format</button> <button id="select2searchBtn" class="rounded-md border border-gray-600 bg-gray-700 px-4 py-2 text-xs font-medium text-gray-300 transition-all hover:bg-gray-600" data-active="false" data-astro-cid-mwlrrin4>Select to Search</button> <button id="caseSensitiveBtn" class="rounded-md border border-gray-600 bg-gray-700 px-4 py-2 text-xs font-medium text-gray-300 transition-all hover:bg-gray-600" data-active="false" data-astro-cid-mwlrrin4>Case Sensitive</button> <button id="wholeWordBtn" class="rounded-md border border-gray-600 bg-gray-700 px-4 py-2 text-xs font-medium text-gray-300 transition-all hover:bg-gray-600" data-active="false" data-astro-cid-mwlrrin4>Whole Word</button> </div> </div> </div> <!-- Status --> <div class="mb-4 flex items-center gap-4" data-astro-cid-mwlrrin4> <span id="statusValid" class="text-sm font-medium text-green-500" data-astro-cid-mwlrrin4></span> <span id="statusError" class="text-sm font-medium text-red-500" data-astro-cid-mwlrrin4></span> </div> <!-- Editor Toolbar --> <div class="flex flex-wrap items-center justify-between gap-4 border-b border-gray-700 bg-gray-800 px-5 py-4" data-astro-cid-mwlrrin4> <div class="flex items-center gap-3" data-astro-cid-mwlrrin4> <button id="copyButton" class="rounded-md bg-gray-600 p-2 text-gray-100 transition-colors hover:bg-gray-500" title="Copy" data-astro-cid-mwlrrin4> <svg data-astro-cid-mwlrrin4="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-clipboard-list"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M9 5h-2a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-12a2 2 0 0 0 -2 -2h-2"></path><path d="M9 3m0 2a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v0a2 2 0 0 1 -2 2h-2a2 2 0 0 1 -2 -2z"></path><path d="M9 12l.01 0"></path><path d="M13 12l2 0"></path><path d="M9 16l.01 0"></path><path d="M13 16l2 0"></path></svg> </button> <button id="clearButton" class="rounded-md bg-gray-600 p-2 text-gray-100 transition-colors hover:bg-gray-500" title="Clear" data-astro-cid-mwlrrin4> <svg data-astro-cid-mwlrrin4="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-trash"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M4 7l16 0"></path><path d="M10 11l0 6"></path><path d="M14 11l0 6"></path><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12"></path><path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3"></path></svg> </button> <button id="undoButton" class="rounded-md bg-gray-600 p-2 text-gray-100 transition-colors hover:bg-gray-500" title="Undo" data-astro-cid-mwlrrin4> <svg data-astro-cid-mwlrrin4="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-arrow-back-up"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M9 14l-4 -4l4 -4"></path><path d="M5 10h11a4 4 0 1 1 0 8h-1"></path></svg> </button> <button id="redoButton" class="rounded-md bg-gray-600 p-2 text-gray-100 transition-colors hover:bg-gray-500" title="Redo" data-astro-cid-mwlrrin4> <svg data-astro-cid-mwlrrin4="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-arrow-forward-up"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M15 14l4 -4l-4 -4"></path><path d="M19 10h-11a4 4 0 1 0 0 8h1"></path></svg> </button> </div> <div class="flex items-center gap-3" data-astro-cid-mwlrrin4> <select id="historyPicklist" class="max-w-72 min-w-48 rounded-md border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-100" data-astro-cid-mwlrrin4> <option disabled selected data-astro-cid-mwlrrin4>JSON History</option> </select> <button id="clearHistoryButton" class="rounded-md bg-red-600 px-3 py-2 text-sm font-medium text-white transition-colors hover:bg-red-700" data-astro-cid-mwlrrin4>Clear</button> </div> </div> <!-- JSON Editor (CodeMirror will be initialized here) --> <div id="jsonEditor" class="mt-4 overflow-visible rounded-lg border border-gray-700 bg-gray-800" data-astro-cid-mwlrrin4></div> </div>  </body></html> <script>
	// Global variables
	let codeMirrorEditor;
	let undoStack = [];
	let redoStack = [];
	let currentValue = '';

	// Toggle button states - CORRECT DEFAULTS
	let toggleStates = {
		cleanEscapes: false, // INACTIVO por defecto
		autoFormat: true, // ACTIVO por defecto
		select2search: false, // INACTIVO por defecto
		caseSensitive: false, // INACTIVO por defecto
		wholeWord: false, // INACTIVO por defecto
	};

	document.addEventListener('DOMContentLoaded', function () {
		// Wait for CodeMirror to load
		if (typeof CodeMirror === 'undefined') {
			setTimeout(
				() => document.dispatchEvent(new Event('DOMContentLoaded')),
				100
			);
			return;
		}

		initializeCodeMirror();
		const savedText = localStorage.getItem('textoJSON');

		// Load saved text
		if (savedText) {
			setEditorContent(savedText);
			currentValue = savedText;
		}

		updateHistoryPicklist();
		initializeEventListeners();
		loadToggleStates();
	});

	function initializeCodeMirror() {
		const editorContainer = document.getElementById('jsonEditor');

		codeMirrorEditor = CodeMirror(editorContainer, {
			mode: 'application/json',
			theme: 'default',
			lineNumbers: true,
			lineWrapping: true,
			foldGutter: true,
			gutters: ['CodeMirror-linenumbers', 'CodeMirror-foldgutter'],
			indentUnit: 2,
			tabSize: 2,
			matchBrackets: true,
			autoCloseBrackets: true,
			showCursorWhenSelecting: true,
			viewportMargin: Infinity, // CRITICAL: This removes internal scroll and makes it auto-size
			scrollbarStyle: null, // Remove all scrollbars
			extraKeys: {
				'Ctrl-Q': function (cm) {
					cm.foldCode(cm.getCursor());
				},
				'Alt-F': function (cm) {
					cm.foldCode(cm.getCursor());
				},
				'Ctrl-F': function (cm) {
					document.getElementById('searchInput').focus();
					return false;
				},
				'Ctrl-H': function (cm) {
					document.getElementById('replaceInput').focus();
					return false;
				},
				'Ctrl-Z': function (cm) {
					undo();
					return false;
				},
				'Ctrl-Y': function (cm) {
					redo();
					return false;
				},
				'Shift-Ctrl-Z': function (cm) {
					redo();
					return false;
				},
			},
		});

		// Force the editor to have no fixed height and auto-resize
		setTimeout(() => {
			if (codeMirrorEditor) {
				codeMirrorEditor.setSize(null, 'auto');
				codeMirrorEditor.refresh();
			}
		}, 100);

		// Set up change listener
		codeMirrorEditor.on('change', function (cm, change) {
			if (change.origin !== 'setValue') {
				saveToUndoStack();
				const text = cm.getValue();
				localStorage.setItem('textoJSON', text);

				if (toggleStates.autoFormat) {
					debounce(formatJSON, 500)();
				}

				validateJSON();
			}
		});

		// Set up selection listener for select to search
		codeMirrorEditor.on('cursorActivity', function (cm) {
			if (toggleStates.select2search && cm.somethingSelected()) {
				const selectedText = cm.getSelection().trim();
				if (selectedText.length > 0) {
					document.getElementById('searchInput').value = selectedText;
					performSearch();
				}
			}
		});
	}

	function updateEditorSize() {
		if (!codeMirrorEditor) return;
		// Just refresh the editor since viewportMargin: Infinity handles the auto-sizing
		codeMirrorEditor.refresh();
	}

	function initializeEventListeners() {
		// Main action buttons
		document
			.getElementById('formatButton')
			.addEventListener('click', formatJSON);
		document
			.getElementById('compressButton')
			.addEventListener('click', compressJSON);

		// Search and replace
		document
			.getElementById('searchInput')
			.addEventListener('input', performSearch);
		document
			.getElementById('replaceAllButton')
			.addEventListener('click', replaceAll);

		// History buttons
		document.getElementById('undoButton').addEventListener('click', undo);
		document.getElementById('redoButton').addEventListener('click', redo);
		document
			.getElementById('clearHistoryButton')
			.addEventListener('click', clearHistory);

		// Utility buttons
		document
			.getElementById('copyButton')
			.addEventListener('click', copyToClipboard);
		document
			.getElementById('clearButton')
			.addEventListener('click', clearEditor);

		// Toggle buttons
		setupToggleButtons();
	}

	function setupToggleButtons() {
		const toggleButtons = [
			'cleanEscapesBtn',
			'autoFormatBtn',
			'select2searchBtn',
			'caseSensitiveBtn',
			'wholeWordBtn',
		];

		toggleButtons.forEach((buttonId) => {
			const button = document.getElementById(buttonId);
			const key = buttonId.replace('Btn', '');

			button.addEventListener('click', function () {
				toggleStates[key] = !toggleStates[key];
				updateToggleButton(button, toggleStates[key]);
				saveToggleStates();

				// Trigger search update for search-related toggles
				if (key === 'caseSensitive' || key === 'wholeWord') {
					performSearch();
				}
			});
		});
	}

	function updateToggleButton(button, active) {
		button.setAttribute('data-active', active.toString());
		if (active) {
			// Active state - blue background
			button.className =
				'px-4 py-2 bg-blue-600 text-white border border-blue-600 rounded-md text-xs font-medium transition-all';
		} else {
			// Inactive state - gray background
			button.className =
				'px-4 py-2 bg-gray-700 hover:bg-gray-600 text-gray-300 border border-gray-600 rounded-md text-xs font-medium transition-all';
		}
	}

	function saveToggleStates() {
		localStorage.setItem(
			'jsonFormatterToggles',
			JSON.stringify(toggleStates)
		);
	}

	function loadToggleStates() {
		// FORCE correct default states - ignore localStorage for now to fix the issue
		toggleStates = {
			cleanEscapes: true, // INACTIVO por defecto
			autoFormat: true, // ACTIVO por defecto
			select2search: false, // INACTIVO por defecto
			caseSensitive: false, // INACTIVO por defecto
			wholeWord: false, // INACTIVO por defecto
		};

		// Clear incorrect localStorage data
		localStorage.removeItem('jsonFormatterToggles');

		// Save correct defaults
		saveToggleStates();

		// Update UI with correct states
		Object.keys(toggleStates).forEach((key) => {
			const button = document.getElementById(key + 'Btn');
			if (button) {
				updateToggleButton(button, toggleStates[key]);
			}
		});
	}

	function setEditorContent(text) {
		if (codeMirrorEditor) {
			codeMirrorEditor.setValue(text);
		}
	}

	function getEditorContent() {
		if (codeMirrorEditor) {
			return codeMirrorEditor.getValue();
		}
		return '';
	}

	// ===== SEARCH AND REPLACE =====
	function performSearch() {
		const searchText = document.getElementById('searchInput').value;
		const counterElement = document.getElementById('searchCounter');
		const counterContainer = document.getElementById(
			'searchCounterContainer'
		);

		if (searchText.length < 1) {
			clearHighlights();
			counterElement.innerText = '';
			counterContainer.classList.add('hidden');
			return;
		}

		const flags = toggleStates.caseSensitive ? 'g' : 'gi';
		let pattern = escapeRegExp(searchText);
		if (toggleStates.wholeWord) {
			pattern = '\\b' + pattern + '\\b';
		}

		const regex = new RegExp(pattern, flags);
		const text = getEditorContent();
		const matches = text.match(regex);
		const count = matches ? matches.length : 0;

		if (count > 0) {
			counterElement.innerText = `${count} matches`;
			counterContainer.classList.remove('hidden');
			counterContainer.classList.add('flex');
			highlightSearchInCodeMirror(searchText);
		} else {
			counterElement.innerText = '';
			counterContainer.classList.add('hidden');
			clearHighlights();
		}
	}

	function replaceAll() {
		const searchText = document.getElementById('searchInput').value;
		const replaceText = document.getElementById('replaceInput').value;

		if (!searchText || !codeMirrorEditor) return;

		const flags = toggleStates.caseSensitive ? 'g' : 'gi';
		let pattern = escapeRegExp(searchText);
		if (toggleStates.wholeWord) {
			pattern = '\\b' + pattern + '\\b';
		}

		const regex = new RegExp(pattern, flags);
		const originalText = getEditorContent();
		const newText = originalText.replace(regex, replaceText);

		if (originalText !== newText) {
			saveToUndoStack();
			setEditorContent(newText);
			localStorage.setItem('textoJSON', newText);
			performSearch();
			validateJSON();
		}
	}

	function highlightSearchInCodeMirror(searchText) {
		if (!codeMirrorEditor) return;

		// Clear previous highlights
		clearHighlights();

		const flags = toggleStates.caseSensitive ? 'g' : 'gi';
		let pattern = escapeRegExp(searchText);
		if (toggleStates.wholeWord) {
			pattern = '\\b' + pattern + '\\b';
		}

		const regex = new RegExp(pattern, flags);
		const text = codeMirrorEditor.getValue();
		const doc = codeMirrorEditor.getDoc();

		// Find and mark all matches
		let match;
		while ((match = regex.exec(text)) !== null) {
			const start = doc.posFromIndex(match.index);
			const end = doc.posFromIndex(match.index + match[0].length);

			doc.markText(start, end, {
				className: 'search-highlight',
			});

			if (!regex.global) break;
		}
	}

	function clearHighlights() {
		if (!codeMirrorEditor) return;

		const doc = codeMirrorEditor.getDoc();
		const marks = doc.getAllMarks();
		marks.forEach((mark) => {
			if (mark.className === 'search-highlight') {
				mark.clear();
			}
		});
	}

	// ===== FORMATTING AND COMPRESSION =====
	function formatJSON() {
		let text = getEditorContent().trim();

		if (!text) return;

		if (toggleStates.cleanEscapes) {
			text = cleanEscapes(text);
		}

		try {
			const parsed = JSON.parse(text);
			saveToUndoStack();
			setEditorContent(JSON.stringify(parsed, null, 2));
			showStatus('JSON formatted successfully', 'valid');
			addToHistory(getEditorContent());
		} catch (e) {
			showStatus('Error: ' + e.message, 'error');
		}
	}

	function compressJSON() {
		const text = getEditorContent().trim();

		if (!text) return;

		try {
			const parsed = JSON.parse(text);
			saveToUndoStack();
			setEditorContent(JSON.stringify(parsed));
			showStatus('JSON compressed successfully', 'valid');
			addToHistory(getEditorContent());
		} catch (e) {
			showStatus('Error: ' + e.message, 'error');
		}
	}

	function cleanEscapes(text) {
		return text
			.replace(/\\n/g, '')
			.replace(/\\\\/g, '\\')
			.replace(/\\t/g, '')
			.replace(/\\r/g, '')
			.replace(/\s+/g, ' ')
			.trim();
	}

	// ===== UNDO/REDO =====
	function saveToUndoStack() {
		const currentText = getEditorContent();
		if (currentValue !== currentText) {
			undoStack.push(currentValue);
			if (undoStack.length > 50) {
				undoStack.shift();
			}
			redoStack = [];
			currentValue = currentText;
		}
	}

	function undo() {
		if (undoStack.length > 0) {
			redoStack.push(currentValue);
			const previousValue = undoStack.pop();
			setEditorContent(previousValue);
			currentValue = previousValue;
			localStorage.setItem('textoJSON', previousValue);
			validateJSON();
		}
	}

	function redo() {
		if (redoStack.length > 0) {
			undoStack.push(currentValue);
			const nextValue = redoStack.pop();
			setEditorContent(nextValue);
			currentValue = nextValue;
			localStorage.setItem('textoJSON', nextValue);
			validateJSON();
		}
	}

	// ===== VALIDATION AND STATUS =====
	function validateJSON() {
		const text = getEditorContent().trim();

		if (!text) {
			showStatus('', '');
			return;
		}

		try {
			JSON.parse(text);
			showStatus('Valid JSON', 'valid');
		} catch (e) {
			showStatus('Error: ' + e.message, 'error');
		}
	}

	function showStatus(message, type) {
		document.getElementById('statusValid').innerText =
			type === 'valid' ? message : '';
		document.getElementById('statusError').innerText =
			type === 'error' ? message : '';
	}

	// ===== UTILITY FUNCTIONS =====
	function debounce(func, wait) {
		let timeout;
		return function executedFunction(...args) {
			const later = () => {
				clearTimeout(timeout);
				func(...args);
			};
			clearTimeout(timeout);
			timeout = setTimeout(later, wait);
		};
	}

	function escapeRegExp(string) {
		return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
	}

	function copyToClipboard() {
		if (!codeMirrorEditor) return;

		const text = getEditorContent();
		if (navigator.clipboard) {
			navigator.clipboard.writeText(text).then(() => {
				showStatus('Copied to clipboard', 'valid');
				setTimeout(() => showStatus('', ''), 2000);
			});
		} else {
			// Fallback for older browsers
			const textArea = document.createElement('textarea');
			textArea.value = text;
			document.body.appendChild(textArea);
			textArea.select();
			document.execCommand('copy');
			document.body.removeChild(textArea);
			showStatus('Copied to clipboard', 'valid');
			setTimeout(() => showStatus('', ''), 2000);
		}
	}

	function clearEditor() {
		if (!codeMirrorEditor) return;

		saveToUndoStack();
		setEditorContent('');
		currentValue = '';
		localStorage.removeItem('textoJSON');
		showStatus('', '');
	}

	// ===== HISTORY MANAGEMENT =====
	function addToHistory(jsonText) {
		if (!jsonText.trim()) return;

		const history = JSON.parse(localStorage.getItem('jsonHistory') || '[]');

		if (checkDuplicateInHistory(jsonText)) return;

		const entry = {
			timestamp: new Date().toISOString(),
			text: jsonText,
		};

		history.unshift(entry);
		const trimmedHistory = history.slice(0, 50);
		localStorage.setItem('jsonHistory', JSON.stringify(trimmedHistory));
		updateHistoryPicklist();
	}

	function checkDuplicateInHistory(jsonText) {
		const history = JSON.parse(localStorage.getItem('jsonHistory') || '[]');
		return history.some((entry) => entry.text === jsonText);
	}

	function clearHistory() {
		localStorage.setItem('jsonHistory', JSON.stringify([]));
		updateHistoryPicklist();
	}

	function updateHistoryPicklist() {
		const history = JSON.parse(localStorage.getItem('jsonHistory') || '[]');
		const picklist = document.getElementById('historyPicklist');

		picklist.innerHTML = '<option disabled selected>JSON History</option>';

		history.forEach((entry) => {
			const date = new Date(entry.timestamp);
			const dateString = `[${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())} ${pad(date.getDate())}/${pad(date.getMonth() + 1)}/${date.getFullYear()}]`;
			const textPreview = entry.text
				? entry.text.substring(0, 80) + '...'
				: '';
			const option = new Option(
				dateString + ' ' + textPreview,
				JSON.stringify(entry)
			);
			picklist.add(option);
		});
	}

	function pad(number) {
		return number < 10 ? '0' + number : number;
	}

	function loadFromHistory(selectedValue) {
		if (!selectedValue) return;

		const entry = JSON.parse(selectedValue);
		if (entry && entry.text) {
			saveToUndoStack();
			setEditorContent(entry.text);
			currentValue = entry.text;
			localStorage.setItem('textoJSON', entry.text);
			validateJSON();
		}
	}
</script> 